import { HttpClient } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { map } from 'rxjs';
import { storageService } from './storage.service';

@Injectable({
  providedIn: 'root'
})
export class BitcoinService {
   
  TRADE_VOLUME_KEY = 'tradeVolume' 

  constructor(private http: HttpClient) { }

  getRate(coins: number) {
    return this.http.get(`https://blockchain.info/tobtc?currency=USD&value=${coins}`)
    .pipe(map(res =>  res))    
  }
  
  getTradeVolume() {
    const data = storageService.load(this.TRADE_VOLUME_KEY)
    // console.log('data service', data);
    
    if(data) return data
    return this.http.get<{values: [{x,y}]}>(`https://api.blockchain.info/charts/trade-volume?timespan=5months&format=json&cors=true`)
    .pipe(map(res => {
      //prepare the data in a way that the chart can render
      const vals = res.values.map(item => {return {name: new Date (item.x * 1000).toLocaleDateString("en-US"), value: item.y }})
      storageService.store(this.TRADE_VOLUME_KEY, vals)
     return vals
    }))
  }

}

// {"status":"ok","name":"USD Exchange Trade Volume","unit":"Trade Volume (USD)","period":"day","description":"The total USD value of trading volume on major bitcoin exchanges.","values":[{"x":1637625600,"y":4.9476255634959996E8},{"x":1637712000,"y":4.8019947588900006E8},{"x":1637798400,"y":3.324094387548E8},{"x":1637884800,"y":2.89094884176E8},{"x":1637971200,"y":7.774925830165E8},{"x":1638057600,"y":2.77078998492E8},{"x":1638144000,"y":2.5273629937800002E8},{"x":1638230400,"y":3.6782653049249995E8},{"x":1638316800,"y":5.2250621422769994E8},{"x":1638403200,"y":4.796689442496E8},{"x":1638489600,"y":4.318852712832E8},{"x":1638576000,"y":5.053790178231999E8},{"x":1638662400,"y":1.243669815772E9},{"x":1638748800,"y":6.183476701116E8},{"x":1638835200,"y":5.957367956247E8},{"x":1638921600,"y":3.085434861643E8},{"x":1639008000,"y":3.014943088344E8},{"x":1639094400,"y":3.556041235776E8},{"x":1639180800,"y":3.376286564944E8},{"x":1639267200,"y":2.125034346582E8},{"x":1639353600,"y":2.02841550615E8},{"x":1639440000,"y":5.039614755761E8},{"x":1639526400,"y":3.458598826347E8},{"x":1639612800,"y":4.3289908432320005E8},{"x":1639699200,"y":2.735095364848E8},{"x":1639785600,"y":3.5630989502760005E8},{"x":1639872000,"y":1.5958110635739997E8},{"x":1639958400,"y":1.925335177216E8},{"x":1640044800,"y":2.762026235283E8},{"x":1640131200,"y":3.455142757818E8},{"x":1640217600,"y":2.11733671302E8},{"x":1640304000,"y":3.126001419432E8},{"x":1640390400,"y":2.3908165785399997E8},{"x":1640476800,"y":1.231949001099E8},{"x":1640563200,"y":1.414983637274E8},{"x":1640649600,"y":1.9366891830400002E8},{"x":1640736000,"y":3.5806905404760003E8},{"x":1640822400,"y":2.6537055954700002E8},{"x":1640908800,"y":2.668889720112E8},{"x":1640995200,"y":3.1387772639159995E8},{"x":1641081600,"y":1.804947582702E8},{"x":1641168000,"y":1.27274108004E8},{"x":1641254400,"y":2.00401831049E8},{"x":1641340800,"y":2.4688775941680002E8},{"x":1641427200,"y":4.619849323115E8},{"x":1641513600,"y":3.936378823188E8},{"x":1641600000,"y":4.889569568856E8},{"x":1641686400,"y":2.192396766817E8},{"x":1641772800,"y":1.831376673576E8},{"x":1641859200,"y":4.2942472521000004E8},{"x":1641945600,"y":3.3003846048370004E8},{"x":1642032000,"y":3.0607900356E8},{"x":1642118400,"y":2.7218957350680006E8},{"x":1642204800,"y":2.17414771965E8},{"x":1642291200,"y":1.115687287393E8},{"x":1642377600,"y":1.0763756829E8},{"x":1642464000,"y":1.547831674775E8},{"x":1642550400,"y":2.028657350568E8},{"x":1642636800,"y":2.196498041615E8},{"x":1642723200,"y":2.894285570358E8},{"x":1642809600,"y":7.536870648299999E8},{"x":1642896000,"y":4.463186674657E8},{"x":1642982400,"y":2.573659784504E8},{"x":1643068800,"y":7.373865958216001E8},{"x":1643155200,"y":2.8895779911689997E8},{"x":1643241600,"y":4.3949510073E8},{"x":1643328000,"y":3.436429090705E8},{"x":1643414400,"y":2.5237598758350003E8},{"x":1643500800,"y":1.472135013288E8},{"x":1643587200,"y":8.74153114308E7},{"x":1643673600,"y":2.3044620779169998E8},{"x":1643760000,"y":2.714063570686E8},{"x":1643846400,"y":2.1117005974400002E8},{"x":1643932800,"y":1.6351442692000002E8},{"x":1644019200,"y":4.569582678625E8},{"x":1644105600,"y":2.0949090441120002E8},{"x":1644192000,"y":1.410854075202E8},{"x":1644278400,"y":4.030174316634E8},{"x":1644364800,"y":3.6673122748639995E8},{"x":1644451200,"y":2.69200808685E8},{"x":1644537600,"y":4.6425841752779996E8},{"x":1644624000,"y":3.2255918127099997E8},{"x":1644710400,"y":1.404550806988E8},{"x":1644796800,"y":9.06733016639E7},{"x":1644883200,"y":1.8782665538700002E8},{"x":1644969600,"y":2.35405883064E8},{"x":1645056000,"y":1.735182521539E8},{"x":1645142400,"y":3.271537710551E8},{"x":1645228800,"y":2.6675139553800002E8},{"x":1645315200,"y":8.152701956650001E7},{"x":1645401600,"y":1.907497671736E8},{"x":1645488000,"y":3.762979850144E8},{"x":1645574400,"y":2.8508760245299995E8},{"x":1645660800,"y":2.4516537696400002E8},{"x":1645747200,"y":8.460618493402E8},{"x":1645833600,"y":2.90502971352E8},{"x":1645920000,"y":1.4638900643690002E8},{"x":1646006400,"y":2.493862548432E8},{"x":1646092800,"y":5.86750288004E8},{"x":1646179200,"y":6.000264347954E8},{"x":1646265600,"y":3.8492200782E8},{"x":1646352000,"y":3.46402069068E8},{"x":1646438400,"y":4.959576045125E8},{"x":1646524800,"y":1.182940869836E8},{"x":1646611200,"y":1.755442675295E8},{"x":1646697600,"y":2.9698514340000004E8},{"x":1646784000,"y":2.7909285064199996E8},{"x":1646870400,"y":4.096769850096E8},{"x":1646956800,"y":3.6002849781E8},{"x":1647043200,"y":2.679113376576E8},{"x":1647129600,"y":1.16260660526E8},{"x":1647216000,"y":1.389914460656E8},{"x":1647302400,"y":2.4002398133999997E8},{"x":1647388800,"y":2.135840097006E8},{"x":1647475200,"y":6.529436326044E8},{"x":1647561600,"y":2.087155648872E8},{"x":1647648000,"y":2.462510638129E8},{"x":1647734400,"y":1.172171825608E8},{"x":1647820800,"y":1.430987167617E8},{"x":1647907200,"y":1.88238486312E8},{"x":1647993600,"y":3.266420147693E8},{"x":1648080000,"y":2.2764094779139996E8},{"x":1648166400,"y":2.795533571948E8},{"x":1648252800,"y":2.948077774845E8},{"x":1648339200,"y":8.76558601288E7},{"x":1648425600,"y":2.1508580713829997E8},{"x":1648512000,"y":3.632002137945E8},{"x":1648598400,"y":2.227679324699E8},{"x":1648684800,"y":1.9823000614560002E8},{"x":1648771200,"y":2.17720733859E8},{"x":1648857600,"y":3.431824054464E8},{"x":1648944000,"y":1.2866615454E8},{"x":1649030400,"y":1.34898633464E8},{"x":1649116800,"y":2.221012555622E8},{"x":1649203200,"y":1.831102732288E8},{"x":1649289600,"y":4.143048249626E8},{"x":1649376000,"y":1.729175814016E8},{"x":1649462400,"y":2.106721529154E8},{"x":1649548800,"y":6.82070008752E7},{"x":1649635200,"y":1.074867514035E8},{"x":1649721600,"y":3.096634398608E8},{"x":1649808000,"y":2.39384869614E8},{"x":1649894400,"y":2.259765044274E8},{"x":1649980800,"y":1.6876484925300002E8},{"x":1650067200,"y":1.12772413352E8},{"x":1650153600,"y":5.3175059972399995E7},{"x":1650240000,"y":7.32156032505E7},{"x":1650326400,"y":2.8737305892840004E8},{"x":1650412800,"y":1.57094338602E8},{"x":1650499200,"y":1.7046494473680001E8},{"x":1650585600,"y":2.756634011415E8}]}
